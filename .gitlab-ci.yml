variables:
  IMAGE_NAME: aws-access-key-manager
  IMAGE_FILE_PATH: $CI_PROJECT_DIR

include:
  - project: christiantragesser/gitlab-ci-templates
    ref: master
    file:
      - kaniko.yml

stages:
  - publish

publish:container
  stage: publish
  tags:
    - docker
  extends:
    - .kaniko
  variables:
    DOCKER_BUILD_STAGE: publish
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      changes:
        - go.*
        - main.go
        - utils/*
        - Dockerfile

publish:artifact
  stage: publish
  extends:
    - .kaniko
  variables:
    DOCKER_BUILD_STAGE: binary
    KANIKO_ADDITIONAL_ARGS: --destination registry.local/image:latest --no-push --ignore-path /aws-access-key-manager
  artifacts:
    paths:
      - aws-access-key-manager
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      changes:
        - go.*
        - main.go
        - utils/*
        - Dockerfile